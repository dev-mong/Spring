<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.aia.rl.dao.RequestDao">

	<resultMap id="requestList"
		type="com.aia.rl.model.RequestReg">
		<result property="reqIdx" column="request_idx" />
		<result property="reqWriter" column="request_writer" />
		<result property="reqTitle" column="request_title" />
		<result property="reqHelper" column="request_helper" />
		<result property="reqDateTime" column="request_date" />
		<result property="reqAddr" column="request_addr" />
		<result property="reqContents" column="request_contents" />
		<result property="reqLatitude" column="request_latitude" />
		<result property="reqLongitude" column="request_longitude" />
		<result property="reqCount" column="request_count" />
		<result property="reqStatus" column="request_status" />
		<result property="reqImg" column="request_img" />
	</resultMap>

	<!-- 게시글 등록 -->
	<insert id="insertRequest"
		parameterType="com.aia.rl.model.RequestReg">
		insert Mangchi.request_list
		(request_writer,request_title,request_helper,request_addr,request_contents,request_latitude,request_longitude,request_img)
		values(#{reqWriter},#{reqTitle},#{reqHelper},#{reqAddr},#{reqContents},#{reqLatitude},#{reqLongitude},#{reqImg})
	</insert>




	<!-- 비회원 게시글 출력 -->
	<select id="selectAllList" resultMap="requestList" parameterType="map">
		select * from
		Mangchi.request_list limit #{startRow}, #{count}
	</select> 
	
	<!-- 비회원 전체 게시물 수 -->
	<select id="allTotalCount" resultType="int">
		select count(*) from
		Mangchi.request_list
	</select>

	
	<!-- 회원 거리 순으로 출력 -->
	<select id="loginDistanceAll" parameterType="map" resultMap="requestList">
		<![CDATA[SELECT *,
		(6371*acos(cos(radians(#{distanceMap.mLat}))*cos(radians(request_latitude))*cos(radians(request_longitude)
		-radians(#{distanceMap.mLon}))+sin(radians(#{distanceMap.mLat}))*sin(radians(request_latitude))))
		AS distance
		FROM Mangchi.request_list
		HAVING distance < #{distanceMap.mRadius}
		ORDER BY distance
		limit #{searchMap.startRow}, #{searchMap.count}]]>
	</select>
	
	<!-- 회원 날짜 순으로 출력 -->
	<select id="loginDateAll" parameterType="map" resultMap="requestList">
		<![CDATA[SELECT *,
		(6371*acos(cos(radians(#{distanceMap.mLat}))*cos(radians(request_latitude))*cos(radians(request_longitude)
		-radians(#{distanceMap.mLon}))+sin(radians(#{distanceMap.mLat}))*sin(radians(request_latitude))))
		AS distance
		FROM Mangchi.request_list
		HAVING distance < #{distanceMap.mRadius}
		ORDER BY request_date
		limit #{searchMap.startRow}, #{searchMap.count}]]>
	</select>
	


	<!-- 검색어가 있을 떄 전체 게시물 수  -->
	<select id="totalCount" resultType="int" parameterType="map">
		select count(*) from Mangchi.request_list
		<where>
			<if test="type != null">
				<if test="type == 'title'">
					<include refid="wheretitle" />
				</if>
				<if test="type == 'name'">
					<include refid="whereName" />
				</if>
			</if>
		</where>
	</select>


	<select id="selectRequestList" parameterType="map"
		resultMap="requestList">

		select * from Mangchi.request_list
		<where>
			<if test="type != null">
				<if test="type == 'title'">
					<include refid="wheretitle" />
				</if>
				<if test="type == 'name'">
					<include refid="whereName" />
				</if>
			</if>
		</where>
		limit #{startRow}, #{count}
	</select>


	<sql id="wheretitle">
		or request_title like concat('%',#{search},'%')
	</sql>

	<sql id="whereName">
		or request_writer like concat('%',#{search},'%')
	</sql>



	<!-- 회원 거리 순으로 출력 -->
	<select id="searchDistance" parameterType="map" resultMap="requestList">
		SELECT *,
		(6371*acos(cos(radians(#{distanceMap.mLat}))*cos(radians(request_latitude))*cos(radians(request_longitude)
		-radians(#{distanceMap.mLon}))+sin(radians(#{distanceMap.mLat}))*sin(radians(request_latitude))))
		AS distance
		FROM Mangchi.request_list
		
		<where>
			<if test="searchMap.type != null">
				<if test="searchMap.type == 'title'">
					or request_title like concat('%',#{searchMap.search},'%')
				</if>
				<if test="searchMap.type == 'name'">
					or request_writer like concat('%',#{searchMap.search},'%')
				</if>
			</if>
		</where>
		
		
		<![CDATA[
		HAVING distance < #{distanceMap.mRadius}
		ORDER BY distance
		limit #{searchMap.startRow}, #{searchMap.count}]]>
	</select>
	
	<!-- 회원 날짜 순으로 출력 -->
	<select id="searchDate" parameterType="map" resultMap="requestList">
		SELECT *,
		(6371*acos(cos(radians(#{distanceMap.mLat}))*cos(radians(request_latitude))*cos(radians(request_longitude)
		-radians(#{distanceMap.mLon}))+sin(radians(#{distanceMap.mLat}))*sin(radians(request_latitude))))
		AS distance
		FROM Mangchi.request_list
		
		
		<where>
			<if test="searchMap.type != null">
				<if test="searchMap.type == 'title'">
					or request_title like concat('%',#{searchMap.search},'%')
				</if>
				<if test="searchMap.type == 'name'">
					or request_writer like concat('%',#{searchMap.search},'%')
				</if>
			</if>
		</where>
		
		<![CDATA[
		HAVING distance < #{distanceMap.mRadius}
		ORDER BY request_date
		limit #{searchMap.startRow}, #{searchMap.count}]]>
	</select>








	<select id="selectIdx" resultMap="requestList">
		select * from
		Mangchi.request_list where request_idx=#{idx}
	</select>

	<update id="editRequest"
		parameterType="com.aia.rl.model.RequestReg">
		update Mangchi.request_list set
		request_writer =
		#{reqWriter},
		request_title = #{reqTitle},
		request_contents =
		#{reqContents},
		request_Img = #{reqImg}
		where request_idx = #{reqIdx}
	</update>


	<delete id="deleteRequest">
		delete from Mangchi.request_list where
		request_idx=#{reqIdx}
	</delete>


	<update id="statusEdit" parameterType="int">
		update
		Mangchi.request_list set request_status = #{reqStatus} where
		request_idx = #{idx}
	</update>




</mapper>